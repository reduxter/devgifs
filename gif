Sub TraceFormulaPrecedentsUntilPlainValue()
    Dim rng As Range
    Dim cell As Range
    Dim traceSheet As Worksheet
    Dim logRow As Long
    Dim precedent As Range
    Dim precedentsRange As Range
    Dim externalWorkbook As Workbook
    Dim externalSheet As Worksheet
    Dim lastCell As Range
    Dim externalPath As String
    Dim currentWorkbook As String, currentSheet As String, currentCell As String, currentFormula As String
    Dim externalFileName As String, externalSheetName As String, externalCellAddress As String
    Dim startPos As Integer, endPos As Integer
    Dim linkSources As Variant
    Dim fileOpened As Boolean
    Dim retryAttempts As Integer
    
    ' Enable ScreenUpdating to make the workbook opening visible
    Application.ScreenUpdating = True
    ' Clear the status bar
    Application.StatusBar = False
    
    ' Set up a new sheet to log the trace
    On Error Resume Next
    Set traceSheet = Worksheets("Trace Log")
    If traceSheet Is Nothing Then
        Set traceSheet = ThisWorkbook.Worksheets.Add
        traceSheet.Name = "Trace Log"
    End If
    On Error GoTo 0
    
    traceSheet.Cells.Clear
    traceSheet.Range("A1:F1").Value = Array("Workbook", "Sheet", "Cell", "Formula", "Value", "File Path")
    logRow = 2
    
    ' Select the range you want to trace
    Set rng = Application.InputBox("Select the cell(s) to trace precedents for:", Type:=8)
    
    ' Loop through each cell in the selected range
    For Each cell In rng
        Call TracePrecedentsRecursive(cell, traceSheet, logRow)
    Next cell
    
    ' Clear the status bar after the process is complete
    Application.StatusBar = False
    MsgBox "Precedent trace completed. See 'Trace Log' sheet for details.", vbInformation
End Sub

Sub TracePrecedentsRecursive(ByVal targetCell As Range, ByVal traceSheet As Worksheet, ByRef logRow As Long)
    Dim precedent As Range
    Dim precedentsRange As Range
    Dim externalWorkbook As Workbook
    Dim externalSheet As Worksheet
    Dim lastCell As Range
    Dim currentWorkbook As String, currentSheet As String, currentCell As String, currentFormula As String
    Dim externalFileName As String, externalSheetName As String, externalCellAddress As String
    Dim startPos As Integer, endPos As Integer
    Dim fileOpened As Boolean
    Dim linkSources As Variant
    Dim retryAttempts As Integer
    
    ' Log details of the current cell
    currentWorkbook = targetCell.Parent.Parent.Name
    currentSheet = targetCell.Parent.Name
    currentCell = targetCell.Address
    currentFormula = targetCell.Formula
    
    traceSheet.Cells(logRow, 1).Value = currentWorkbook
    traceSheet.Cells(logRow, 2).Value = currentSheet
    traceSheet.Cells(logRow, 3).Value = currentCell
    traceSheet.Cells(logRow, 4).Value = currentFormula
    traceSheet.Cells(logRow, 5).Value = targetCell.Value
    traceSheet.Cells(logRow, 6).Value = "N/A"  ' Default file path, will be updated
    logRow = logRow + 1
    
    ' If the current cell has no formula, stop tracing (plain value found)
    If Not targetCell.HasFormula Then
        Exit Sub
    End If
    
    ' Try to get the precedents for this cell
    On Error Resume Next
    Set precedentsRange = targetCell.Precedents
    On Error GoTo 0
    
    If Not precedentsRange Is Nothing Then
        ' Loop through all precedents in the range and recursively trace them
        For Each precedent In precedentsRange
            Call TracePrecedentsRecursive(precedent, traceSheet, logRow)
        Next precedent
    ElseIf InStr(currentFormula, "[") > 0 Then
        ' If the cell references an external workbook, handle it
        startPos = InStr(currentFormula, "'[") + 2
        endPos = InStr(currentFormula, "]")
        externalFileName = Mid(currentFormula, startPos, endPos - startPos)
        externalSheetName = Mid(currentFormula, endPos + 2, InStr(endPos + 2, currentFormula, "'") - endPos - 2)
        externalCellAddress = Mid(currentFormula, InStr(currentFormula, "!") + 1)
        
        ' Check if the workbook is already open
        On Error Resume Next
        Set externalWorkbook = Workbooks(externalFileName)
        On Error GoTo 0
        
        ' If not open, resolve the full path using link sources
        If externalWorkbook Is Nothing Then
            linkSources = ThisWorkbook.LinkSources(xlExcelLinks)
            If Not IsEmpty(linkSources) Then
                ' Try to match the file name with the link source to get the full path
                For Each externalPath In linkSources
                    If InStr(externalPath, externalFileName) > 0 Then
                        ' Found the full path for the external file
                        traceSheet.Cells(logRow - 1, 6).Value = externalPath  ' Update the log with the full path
                        Exit For
                    End If
                Next externalPath
            End If
            
            ' Try to open the external workbook using the full path
            retryAttempts = 0
            fileOpened = False
            
            Do While retryAttempts < 5 And Not fileOpened
                retryAttempts = retryAttempts + 1
                On Error Resume Next
                Set externalWorkbook = Workbooks.Open(externalPath, ReadOnly:=True)
                On Error GoTo 0
                
                If Not externalWorkbook Is Nothing Then
                    fileOpened = True
                    traceSheet.Cells(logRow - 1, 6).Value = externalPath  ' Log the successful path
                Else
                    ' If the file is not opened, wait for a few seconds and retry
                    Application.Wait Now + TimeValue("00:00:05") ' Wait for 5 seconds
                End If
            Loop
            
            ' If the workbook could not be opened, log an error and the attempted file path
            If Not fileOpened Then
                traceSheet.Cells(logRow - 1, 5).Value = "Error: Unable to open external workbook"
                traceSheet.Cells(logRow - 1, 6).Value = externalPath ' Log the attempted file path
                Exit Sub
            End If
        End If
        
        ' If the workbook was successfully opened, access the sheet and precedents
        If Not externalWorkbook Is Nothing Then
            Set externalSheet = externalWorkbook.Sheets(externalSheetName)
            Set lastCell = externalSheet.Range(externalCellAddress)
            Call TracePrecedentsRecursive(lastCell, traceSheet, logRow)
        Else
            traceSheet.Cells(logRow - 1, 5).Value = "Error: Unable to open external workbook"
            traceSheet.Cells(logRow - 1, 6).Value = externalPath ' Log the attempted file path
        End If
    End If
End Sub
