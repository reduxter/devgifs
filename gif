
Sub TraceFormulas()
    Dim ws As Worksheet
    Dim cell As Range
    Dim formula As String
    Dim logRow As Integer
    
    ' Open a new workbook to log the results
    Dim logBook As Workbook
    Set logBook = Workbooks.Add
    Dim logSheet As Worksheet
    Set logSheet = logBook.Sheets(1)
    logSheet.Cells(1, 1).Value = "Workbook"
    logSheet.Cells(1, 2).Value = "Sheet"
    logSheet.Cells(1, 3).Value = "Cell"
    logSheet.Cells(1, 4).Value = "Formula"
    logSheet.Cells(1, 5).Value = "Value"
    logRow = 2
    
    ' Set your target worksheet and range here
    Set ws = ThisWorkbook.Sheets("Sheet1") ' Adjust the worksheet as needed
    For Each cell In ws.Range("A1:H4") ' Adjust the range as needed
        formula = cell.Formula
        logSheet.Cells(logRow, 1).Value = ThisWorkbook.Name
        logSheet.Cells(logRow, 2).Value = ws.Name
        logSheet.Cells(logRow, 3).Value = cell.Address
        logSheet.Cells(logRow, 4).Value = formula ' Log the formula
        logSheet.Cells(logRow, 5).Value = cell.Value ' Log the value
        logRow = logRow + 1
        
        ' If the formula references an external workbook, trace it
        If formula <> "" And Left(formula, 1) = "=" Then
            ' Trace any external workbook references found in the formula
            TraceExternalWorkbookReferences formula, logSheet, logRow
        End If
    Next cell
    
    MsgBox "Formula tracing complete. Check the new workbook for details."
End Sub

Sub TraceExternalWorkbookReferences(ByVal formula As String, ByRef logSheet As Worksheet, ByRef logRow As Integer)
    Dim match As Object
    Dim matches As Object
    Dim extWorkbook As Workbook
    Dim refWorkbookPath As String
    Dim refWorksheet As Worksheet
    Dim refCell As Range
    Dim regex As Object
    Dim workbookReference As String
    Dim worksheetName As String
    Dim cellReference As String
    
    ' Regular expression to capture cross-workbook references (e.g., '[C:\path\to\Workbook.xlsx]Sheet1!A1')
    Set regex = CreateObject("VBScript.RegExp")
    regex.Global = True
    regex.IgnoreCase = True
    regex.Pattern = "\[(.*?)\](.*?)!([A-Z]+\d+)"
    
    ' Find all workbook references in the formula
    If regex.Test(formula) Then
        Set matches = regex.Execute(formula)
        
        ' Loop through each match and extract the workbook, sheet, and cell references
        For Each match In matches
            workbookReference = match.SubMatches(0) ' Full path to the workbook (e.g., C:\path\to\Workbook.xlsx)
            worksheetName = match.SubMatches(1) ' Sheet name (e.g., Sheet1)
            cellReference = match.SubMatches(2) ' Cell reference (e.g., A1)
            
            ' Attempt to open the external workbook
            On Error Resume Next
            Set extWorkbook = Workbooks.Open(workbookReference, ReadOnly:=True)
            On Error GoTo 0
            
            If Not extWorkbook Is Nothing Then
                ' Get the referenced worksheet and cell
                Set refWorksheet = extWorkbook.Sheets(worksheetName)
                Set refCell = refWorksheet.Range(cellReference)
                
                ' Log the details of the referenced cell
                logSheet.Cells(logRow, 1).Value = extWorkbook.Name
                logSheet.Cells(logRow, 2).Value = refWorksheet.Name
                logSheet.Cells(logRow, 3).Value = refCell.Address
                logSheet.Cells(logRow, 4).Value = refCell.Formula ' Log the formula
                logSheet.Cells(logRow, 5).Value = refCell.Value ' Log the value
                logRow = logRow + 1
                
                ' If the referenced cell also contains a formula, continue tracing
                If refCell.Formula <> "" Then
                    TraceExternalWorkbookReferences refCell.Formula, logSheet, logRow
                End If
                
                ' Close the external workbook after processing
                extWorkbook.Close False
            Else
                ' Log if the external workbook couldn't be opened
                logSheet.Cells(logRow, 1).Value = "Unable to open workbook: " & workbookReference
                logRow = logRow + 1
            End If
        Next match
    End If
End Sub
