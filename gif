Sub TraceFormulas()
    Dim ws As Worksheet
    Dim cell As Range
    Dim formula As String
    Dim reference As Range
    Dim extWorkbook As Workbook
    Dim refAddress As String
    Dim refWorkbookPath As String
    Dim refWorksheet As Worksheet
    Dim refCell As Range
    Dim logRow As Integer
    
    ' Open a new workbook to log the results
    Dim logBook As Workbook
    Set logBook = Workbooks.Add
    Dim logSheet As Worksheet
    Set logSheet = logBook.Sheets(1)
    logSheet.Cells(1, 1).Value = "Workbook"
    logSheet.Cells(1, 2).Value = "Sheet"
    logSheet.Cells(1, 3).Value = "Cell"
    logSheet.Cells(1, 4).Value = "Formula"
    logSheet.Cells(1, 5).Value = "Value"
    logRow = 2
    
    ' Set your target worksheet and range here
    Set ws = ThisWorkbook.Sheets("Sheet1") ' Adjust the worksheet as needed
    For Each cell In ws.Range("A1:B10") ' Adjust the range as needed
        formula = cell.Formula
        logSheet.Cells(logRow, 1).Value = ThisWorkbook.Name
        logSheet.Cells(logRow, 2).Value = ws.Name
        logSheet.Cells(logRow, 3).Value = cell.Address
        logSheet.Cells(logRow, 4).Value = formula
        logSheet.Cells(logRow, 5).Value = cell.Value
        logRow = logRow + 1
        
        ' Trace formula references
        If formula <> "" And Left(formula, 1) = "=" Then
            On Error Resume Next
            Set reference = Evaluate(formula)
            On Error GoTo 0
            
            If Not reference Is Nothing Then
                ' Handle references in the current workbook
                If Not reference.Worksheet.Parent Is ThisWorkbook Then
                    refWorkbookPath = reference.Worksheet.Parent.FullName
                    Set extWorkbook = Workbooks.Open(refWorkbookPath, False, True)
                    Set refWorksheet = extWorkbook.Sheets(reference.Worksheet.Name)
                    Set refCell = refWorksheet.Range(reference.Address)
                    
                    ' Log the reference details
                    logSheet.Cells(logRow, 1).Value = extWorkbook.Name
                    logSheet.Cells(logRow, 2).Value = refWorksheet.Name
                    logSheet.Cells(logRow, 3).Value = refCell.Address
                    logSheet.Cells(logRow, 4).Value = refCell.Formula
                    logSheet.Cells(logRow, 5).Value = refCell.Value
                    logRow = logRow + 1
                    
                    extWorkbook.Close False
                End If
            End If
        End If
    Next cell
    
    MsgBox "Formula tracing complete. Check the new workbook for details."
End Sub
