import xlwings as xw
import os

def open_workbook_with_links(workbook_path):
    """
    Open a workbook in Excel with links updated and force recalculation.
    """
    if os.path.exists(workbook_path):
        try:
            print(f"Opening workbook: {workbook_path}")
            wb = xw.Book(workbook_path, update_links=True)  # Open workbook with links updated
            return wb
        except Exception as e:
            print(f"Error opening workbook {workbook_path}: {e}")
            return None
    else:
        print(f"Workbook not found: {workbook_path}")
        return None

def update_links_and_recalculate(workbook):
    """
    Force Excel to update links and recalculate all formulas.
    """
    try:
        workbook.app.calculate()  # Trigger recalculation
        print("Workbook recalculated successfully.")
    except Exception as e:
        print(f"Error during recalculation: {e}")

def get_cell_value(workbook, sheet_name, cell_address):
    """
    Get the value of a specific cell after recalculating formulas.
    """
    sheet = workbook.sheets[sheet_name]
    cell_value = sheet.range(cell_address).value  # Get evaluated value after recalculation
    formula = sheet.range(cell_address).formula  # Fetch formula if needed

    return {
        'cell': cell_address,
        'formula': formula,
        'value': cell_value
    }

def trace_formulas_after_recalculation(workbook_path, sheet_name, cell_range):
    """
    Trace formulas in a specified range after recalculating the workbook.
    """
    workbook = open_workbook_with_links(workbook_path)
    if not workbook:
        return []

    # Force recalculation after opening the workbook with links
    update_links_and_recalculate(workbook)

    trace = []
    sheet = workbook.sheets[sheet_name]

    # Loop through the specified range and extract the formulas and values
    for cell in sheet.range(cell_range):
        cell_address = cell.get_address(False, False)
        trace.append(get_cell_value(workbook, sheet_name, cell_address))

    # Close the workbook after extracting data
    workbook.close()

    return trace

# Example usage:
workbook_path = r'\\network_drive\path\to\your\workbook.xlsx'
sheet_name = 'Sheet1'
cell_range = 'A1:B10'  # Range for testing

trace = trace_formulas_after_recalculation(workbook_path, sheet_name, cell_range)

# Print the final trace after recalculation
for step in trace:
    print(f"Cell: {step['cell']}, Formula: {step['formula']}, Value: {step['value']}")
