Sub TrackFormulaToPlainValueRange()
    Dim rng As Range
    Dim cell As Range
    Dim currentFormula As String
    Dim traceSheet As Worksheet
    Dim logRow As Long
    Dim trackedCells As Collection
    Dim externalWorkbook As Workbook
    Dim externalSheet As Worksheet
    Dim externalCell As Range
    Dim circularCheck As Collection
    Dim ws As Worksheet
    Dim wb As Workbook
    Dim lastCell As Range
    Dim currentWorkbook As String, currentSheet As String, currentCell As String, currentValue As String
    Dim formulaTrace As String
    Dim maxTraceDepth As Integer
    Dim fileOpened As Boolean
    Dim fileOpenAttempts As Integer
    Dim externalPath As String ' Variable to store the file path
    
    ' Set up a new sheet to log the trace
    On Error Resume Next
    Set traceSheet = Worksheets("Trace Log")
    If traceSheet Is Nothing Then
        Set traceSheet = ThisWorkbook.Worksheets.Add
        traceSheet.Name = "Trace Log"
    End If
    On Error GoTo 0
    
    traceSheet.Cells.Clear
    traceSheet.Range("A1:F1").Value = Array("Workbook", "Sheet", "Cell", "Formula", "Value", "File Path")
    logRow = 2
    
    ' Select a range to process
    Set rng = Application.InputBox("Select the range to track formulas:", Type:=8)
    
    ' Maximum trace depth to avoid infinite loops in case of circular references
    maxTraceDepth = 100
    
    ' Loop through each cell in the range
    For Each cell In rng
        Set circularCheck = New Collection
        Set lastCell = cell
        formulaTrace = ""
        
        ' Loop to trace each precedent until reaching a plain value
        Do While lastCell.HasFormula And circularCheck.Count < maxTraceDepth
            On Error Resume Next
            circularCheck.Add lastCell.Address, CStr(lastCell.Address)
            On Error GoTo 0
            
            ' Log details
            currentWorkbook = lastCell.Parent.Parent.Name
            currentSheet = lastCell.Parent.Name
            currentCell = lastCell.Address
            currentFormula = lastCell.Formula
            currentValue = lastCell.Value
            
            traceSheet.Cells(logRow, 1).Value = currentWorkbook
            traceSheet.Cells(logRow, 2).Value = currentSheet
            traceSheet.Cells(logRow, 3).Value = currentCell
            traceSheet.Cells(logRow, 4).Value = currentFormula
            traceSheet.Cells(logRow, 5).Value = currentValue
            traceSheet.Cells(logRow, 6).Value = "N/A" ' Default for file path
            logRow = logRow + 1
            
            ' Check if it's an external workbook reference
            If InStr(currentFormula, "[") > 0 Then
                ' Extract the external workbook path and sheet name
                Dim startPos As Integer, endPos As Integer, externalSheetName As String, externalCellAddress As String
                
                startPos = InStr(currentFormula, "'[") + 1
                endPos = InStr(currentFormula, "]")
                externalPath = Mid(currentFormula, startPos + 1, endPos - startPos)
                externalSheetName = Mid(currentFormula, endPos + 2, InStr(endPos + 2, currentFormula, "'") - endPos - 2)
                
                ' Try to open the external workbook with retries in case of network delay
                fileOpenAttempts = 0
                fileOpened = False
                On Error Resume Next
                Do While Not fileOpened And fileOpenAttempts < 5
                    fileOpenAttempts = fileOpenAttempts + 1
                    Set externalWorkbook = Workbooks(externalPath)
                    
                    If externalWorkbook Is Nothing Then
                        Set externalWorkbook = Workbooks.Open(externalPath, ReadOnly:=True)
                    End If
                    
                    ' If the workbook is successfully opened, exit the loop
                    If Not externalWorkbook Is Nothing Then
                        fileOpened = True
                    Else
                        ' If unable to open, wait for a second and retry
                        Application.Wait Now + TimeValue("00:00:03") ' Increased to 3 seconds
                    End If
                Loop
                On Error GoTo 0
                
                ' If after retries the file could not be opened, log the error and skip
                If Not fileOpened Then
                    traceSheet.Cells(logRow, 1).Value = "Error: Unable to open external workbook"
                    traceSheet.Cells(logRow, 2).Value = externalPath
                    traceSheet.Cells(logRow, 3).Value = "N/A"
                    traceSheet.Cells(logRow, 4).Value = currentFormula
                    traceSheet.Cells(logRow, 5).Value = "N/A"
                    traceSheet.Cells(logRow, 6).Value = externalPath ' Log the full file path here
                    logRow = logRow + 1
                    Exit Do
                End If
                
                ' Log the file path if successfully opened
                traceSheet.Cells(logRow - 1, 6).Value = externalPath
                
                ' Get the external sheet and cell
                Set externalSheet = externalWorkbook.Sheets(externalSheetName)
                externalCellAddress = Mid(currentFormula, InStr(currentFormula, "!") + 1)
                Set lastCell = externalSheet.Range(externalCellAddress)
                
            Else
                ' Follow internal references
                Set lastCell = lastCell.Precedents.Cells(1, 1)
            End If
            
            ' Check if the last cell has a plain value
            If Not lastCell.HasFormula Then
                ' Log the final plain value cell
                currentWorkbook = lastCell.Parent.Parent.Name
                currentSheet = lastCell.Parent.Name
                currentCell = lastCell.Address
                currentFormula = lastCell.Formula
                currentValue = lastCell.Value
                
                traceSheet.Cells(logRow, 1).Value = currentWorkbook
                traceSheet.Cells(logRow, 2).Value = currentSheet
                traceSheet.Cells(logRow, 3).Value = currentCell
                traceSheet.Cells(logRow, 4).Value = "Plain Value"
                traceSheet.Cells(logRow, 5).Value = currentValue
                traceSheet.Cells(logRow, 6).Value = "N/A"
                logRow = logRow + 1
                
                Exit Do
            End If
            
        Loop
    Next cell
    
    MsgBox "Formula trace completed. See 'Trace Log' sheet for details.", vbInformation
End Sub
